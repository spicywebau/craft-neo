(()=>{"use strict";var t={n:e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},d:(e,n)=>{for(var i in n)t.o(n,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:n[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};const e=jQuery;var n=t.n(e);const i=Garnish;var s=t.n(i);const o=Craft;var l=t.n(o);const a={_stack:[[]],enter(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if("string"==typeof t&&(t=this.fromFieldName(t)),e){const e=this.getNamespace();e.push(...t),t=e}this._stack.push(t)},enterByFieldName(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.enter(this.fromFieldName(t),e)},leave(){return this._stack.length>1?this._stack.pop():this.getNamespace()},getNamespace(){return Array.from(this._stack[this._stack.length-1])},parse(t){return"string"==typeof t?t.indexOf("[")>-1?this.fromFieldName(t):t.indexOf("-")>-1?t.split("-"):t.indexOf(".")>-1?t.split("."):t:Array.from(t)},value(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"-";const n=this.getNamespace();return n.push(t),n.join(e)},fieldName(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";const e=this.toFieldName();return e?e+t.replace(/([^'"[\]]+)([^'"]*)/,"[$1]$2"):t},toString(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"-";return this.getNamespace().join(t)},toFieldName(){const t=this.getNamespace();switch(t.length){case 0:return"";case 1:return t[0]}return t[0]+"["+t.slice(1).join("][")+"]"},fromFieldName:t=>t.match(/[^[\]\s]+/g)||[]},r=s().Drag.extend({$container:null,blocks:null,maxTopBlocks:0,_draggeeBlocks:null,init(t,e){void 0===e&&n().isPlainObject(t)&&(e=t,t=null),(e=n().extend({},r.defaults,e)).axis=s().Y_AXIS,this.base(t,e),this.$container=e.container,this.blocks=[],this.maxTopBlocks=e.maxTopBlocks},getHelperTargetX(){return this.$draggee.offset().left},getHelperTargetY(){const t=this.settings.magnetStrength;if(1!==t){const e=this.$draggee.offset().top;return e+(this.mouseY-this.mouseOffsetY-e)/t}return this.base()},getBlockByElement(t){return this.blocks.find((e=>e.$container.is(t)))},getParentBlock(t){const e=t.$container.parent().closest(".ni_block");return e.length>0&&this.getBlockByElement(e)},onDragStart(){const t=this;this._draggeeBlocks=[],this.$draggee.each((function(){t._draggeeBlocks.push(t.getBlockByElement(this))})),this.base(),this._calculateMidpoints()},onDrag(){const t=this._getClosestMidpoint();t&&this._moveDraggeeToBlock(t.block,t.type,t.direction),this.base()},onDragStop(){const t=this;this.$draggee.each((function(){const e=n()(this),i=t.getBlockByElement(e);if(e.parent().is(t.$container))i.setLevel(1);else{const e=t.getParentBlock(i);i.setLevel(e.getLevel()+1)}e.find(".ni_block").each((function(){const e=n()(this),i=t.getBlockByElement(e),s=t.getParentBlock(i);i.setLevel(s.getLevel()+1)}))})),this.returnHelpersToDraggees(),this.base()},addBlock(t){this.blocks.push(t),this.addItems(t.$container)},removeBlock(t){this.blocks=this.blocks.filter((e=>e!==t)),this.removeItems(t.$container)},_getClosestMidpoint(){let t=Number.MAX_VALUE,e=Number.MIN_VALUE,n=null;for(const i of this._currentMidpoints)if(i.direction===r.DIRECTION_UP){this.mouseY-this.mouseOffsetY<i.position&&i.position<t&&(t=i.position,n=i)}else{this.mouseY-this.mouseOffsetY+this._draggeeBlockHeight>i.position&&i.position>e&&(e=i.position,n=i)}return n},_calculateMidpoints(){this._draggeeBlockY=this.$draggee.offset().top,this._draggeeBlockHeight=this.$draggee.height()+10,this._currentMidpoints=[];for(const t of this.blocks)if(0===t.$container.closest(this.$draggee).length){const e=this._getBlockMidpoints(t);for(const n of Object.keys(e)){const i=e[n],s=this._draggeeBlockY>i?r.DIRECTION_UP:r.DIRECTION_DOWN;this._currentMidpoints.push({block:t,position:i,type:n,direction:s})}}const t=this.$container.offset().top+this.$container.height()+5;this._currentMidpoints.push({block:null,position:t,type:r.TYPE_END,direction:r.DIRECTION_DOWN})},_getBlockMidpoints(t){const e={};if(!(t.$container.parent().closest(".ni_block.is-collapsed").length>0)){const n=t.$container.offset().top,i=t.isExpanded(),s=t.$container.height(),o=t.$topbarContainer.height(),l=i?t.$childrenContainer.height():0,a=i&&t.$contentContainer.length>0?t.$childrenContainer.length>0?t.$childrenContainer.offset().top-t.$contentContainer.offset().top:t.$contentContainer.height():0,c=this.getParentBlock(t);if(c&&!this._validateDraggeeChildren(c)||(e[r.TYPE_CONTENT]=n+(o+a)/2),l>0&&t.isExpanded()&&this._validateDraggeeChildren(t)){const i=t.getButtons().$container.height();e[r.TYPE_CHILDREN]=n+s-1-(14+i+10)/2}}return e},_moveDraggeeToBlock:function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:r.TYPE_CONTENT,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:r.DIRECTION_DOWN;const i=t?this.getParentBlock(t):null,s=this._validateDraggeeChildren(i);switch(e){case r.TYPE_CHILDREN:0===this.$draggee.closest(t.$container).length?t.$blocksContainer.append(this.$draggee):s&&t.$container.after(this.$draggee);break;case r.TYPE_END:s&&this.$container.append(this.$draggee);break;default:n===r.DIRECTION_UP?s&&t.$container.before(this.$draggee):t.getBlockType().isParent()&&t.isExpanded()&&this._validateDraggeeChildren(t)?t.$blocksContainer.prepend(this.$draggee):s&&t.$container.after(this.$draggee)}this._updateHelperAppearance(),this._calculateMidpoints()},_validateDraggeeChildren(t){const e=t?t.getField():this._draggeeBlocks[0].getField(),n=e.getMaxLevels();if(n>0){const i=t?t.getLevel():-1,s=this._draggeeBlocks[0].getLevel(),o=t=>t.getLevel()-s+i+1>=n,l=t=>{const n=t.getChildren(e.getBlocks(),!0);return o(t)||n.some(l)};if(this._draggeeBlocks.filter(l).length>0)return!1}if(!t){const t=this,e=this.$container.children(".ni_block:not(.is-disabled)");let n=e.length;for(const t of this._draggeeBlocks)if(!t.getBlockType().getTopLevel())return!1;return e.each((function(){t._draggeeBlocks.includes(t.getBlockByElement(this))&&n--})),!(this.maxTopBlocks>0&&n>=this.maxTopBlocks)}const i=t.getBlockType(),s=i.getMaxChildBlocks(),o=t.$childrenContainer.children(".ni_blocks").children(".ni_block");let l=o.length;const a=[],r=this;if(o.each((function(){const t=r.getBlockByElement(this);r._draggeeBlocks.includes(t)?l--:a.push(t)})),s>0&&l>=s)return!1;const c=[];for(const t of this._draggeeBlocks){if(!i.isValidChildBlock(t))return!1;if(c.includes(t))continue;const e=t.getBlockType(),n=e.getMaxSiblingBlocks();if(0===n)continue;const s=this._draggeeBlocks.filter((t=>t.getBlockType().getHandle()===e.getHandle()));if(a.filter((t=>t.getBlockType().getHandle()===e.getHandle())).length+s.length>n)return!1;c.push(...s)}return!0},_updateHelperAppearance(){for(const t of this.helpers){const e=t.data("neo-b-id"),n=this.blocks.find((t=>t.$container.data("neo-b-id")===e));t.css({width:n.$container.width()+1,height:n.$container.height()})}}},{TYPE_CONTENT:"content",TYPE_CHILDREN:"children",TYPE_END:"end",DIRECTION_UP:"up",DIRECTION_DOWN:"down",defaults:{container:null,magnetStrength:1}}),c=r,d={name:"",errors:[]},h=s().Base.extend({init(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t=Object.assign({},d,t),this._name=t.name,this._errors=t.errors,this._uid=t.uid},getErrors(){return Array.from(this._errors)},getName(){return this._name},getUid(){return this._uid}});function u(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,i)}return n}function p(t,e,n){return(e=function(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var i=n.call(t,e||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}const g={id:-1,field:null,fieldLayoutId:-1,sortOrder:0,name:"",handle:"",maxBlocks:0,maxSiblingBlocks:0,maxChildBlocks:0,groupChildBlockTypes:!0,childBlocks:!1,topLevel:!0,tabs:null,tabNames:[],hasChildBlocksUiElement:!1,creatableByUser:!0,deletableByUser:!0,editableByUser:!0},b=s().Base.extend({init(){var t,e,n,i,s,o;let l=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};var a,r;(l=Object.assign({},g,l),this._id=0|l.id,this._field=l.field,this._fieldLayoutId=0|l.fieldLayoutId,this._sortOrder=0|l.sortOrder,this._name=l.name,this._handle=l.handle,this._description=l.description,this._enabled=l.enabled,this._minBlocks=0|l.minBlocks,this._maxBlocks=0|l.maxBlocks,this._minSiblingBlocks=0|l.maxSiblingBlocks,this._maxSiblingBlocks=0|l.maxSiblingBlocks,this._minChildBlocks=0|l.minChildBlocks,this._maxChildBlocks=0|l.maxChildBlocks,this._groupChildBlockTypes=l.groupChildBlockTypes,this._childBlocks=l.childBlocks,this._topLevel=l.topLevel,this._tabNames=l.tabNames,null!==l.tabs)?this._tabs=null!==(a=null===(r=l.tabs.tabNames)||void 0===r?void 0:r.map((t=>t instanceof h?t:new h({name:t,uid:l.tabs.tabUids[t]}))))&&void 0!==a?a:[]:this._tabs=null;this._html=null!==(t=null===(e=l.tabs)||void 0===e?void 0:e.html)&&void 0!==t?t:"",this._js=null!==(n=null===(i=l.tabs)||void 0===i?void 0:i.js)&&void 0!==n?n:"",this._defaultVisibleLayoutElements=null!==(s=null===(o=l.tabs)||void 0===o?void 0:o.visibleLayoutElements)&&void 0!==s?s:{},this._hasChildBlocksUiElement=l.hasChildBlocksUiElement,this._creatableByUser=l.creatableByUser,this._deletableByUser=l.deletableByUser,this._editableByUser=l.editableByUser},getType:()=>"blockType",getId(){return this._id},getFieldLayoutId(){return this._fieldLayoutId},getSortOrder(){return this._sortOrder},getName(){return this._name},getHandle(){return this._handle},getDescription(){return this._description},getEnabled(){return this._enabled},getMinBlocks(){return this._minBlocks},getMaxBlocks(){return this._maxBlocks},getMinSiblingBlocks(){return this._minSiblingBlocks},getMaxSiblingBlocks(){return this._maxSiblingBlocks},getMinChildBlocks(){return this._minChildBlocks},getMaxChildBlocks(){return this._maxChildBlocks},getGroupChildBlockTypes(){return this._groupChildBlockTypes},getChildBlocks(){return this._childBlocks},getTopLevel(){return this._topLevel},getTabNames(){return this._tabNames},getTabs(){return null!==this._tabs?Array.from(this._tabs):null},async loadTabs(){var t,e,n;if(null!==this._tabs)return;a.enter(this._field.getNamespace());const i={namespace:a.toFieldName(),siteId:null===(t=this._field)||void 0===t?void 0:t.getSiteId(),unsavedIds:null===(e=this._field)||void 0===e?void 0:e.getUnsavedIds(),blocks:[{collapsed:!1,enabled:!0,level:1,ownerId:null===(n=this._field)||void 0===n?void 0:n.getOwnerId(),type:this._id}]};a.leave();const s=await l().sendActionRequest("POST","neo/input/render-blocks",{data:i});if(s.data.success){var o,r;s.data.headHtml&&l().appendHeadHtml(s.data.headHtml),s.data.bodyHtml&&l().appendBodyHtml(s.data.bodyHtml);const t=s.data.blocks[0].tabs;this._tabs=null!==(o=null===(r=t.tabNames)||void 0===r?void 0:r.map((e=>new h({name:e,uid:t.tabUids[e]}))))&&void 0!==o?o:[],this._html=t.html,this._js=t.js}},async newBlock(){var t,e,n,i;let s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};a.enter(this._field.getNamespace());const o={namespace:a.toFieldName(),fieldId:null===(t=this._field)||void 0===t?void 0:t.getId(),siteId:null===(e=this._field)||void 0===e?void 0:e.getSiteId(),unsavedIds:null===(n=this._field)||void 0===n?void 0:n.getUnsavedIds(),blocks:[Object.assign({collapsed:!1,enabled:!0,level:1,ownerId:null===(i=this._field)||void 0===i?void 0:i.getOwnerId(),type:this._id},s)]};a.leave();return(await l().sendActionRequest("POST","neo/input/render-blocks",{data:o})).data.blocks[0]},getHtml(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return this._replaceBlockIdPlaceholder(this._html,t)},getJs(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return this._replaceBlockIdPlaceholder(this._js,t)},getDefaultVisibleLayoutElements(){return function(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?u(Object(n),!0).forEach((function(e){p(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):u(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}({},this._defaultVisibleLayoutElements)},_replaceBlockIdPlaceholder(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return null!==e?t.replace(/__NEOBLOCK__/g,e):t},getChildBlockItems(t){const e=t.filter((t=>"group"===t.getType()||this.hasChildBlock(t.getHandle())));return e.filter(((t,n)=>{if("group"===t.getType()){const t=e[n+1];return t&&"group"!==t.getType()}return!0}))},isParent(){const t=this.getChildBlocks();return!0===t||"*"===t||Array.isArray(t)&&t.length>0},hasChildBlock(t){const e=this.getChildBlocks();return!0===e||"*"===e||Array.isArray(e)&&e.includes(t)},isValidChildBlock(t){return this.hasChildBlock(t.getBlockType().getHandle())},hasChildBlocksUiElement(){return this._hasChildBlocksUiElement},isCreatableByUser(){return this._creatableByUser},isDeletableByUser(){return this._deletableByUser},isEditableByUser(){return this._editableByUser}}),f={id:-1,sortOrder:0,alwaysShowDropdown:null,name:""},_=s().Base.extend({init(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t=Object.assign({},f,t),this._id=0|t.id,this._sortOrder=0|t.sortOrder,this._alwaysShowDropdown=t.alwaysShowDropdown,this._name=t.name},getType:()=>"group",getId(){return this._id},getSortOrder(){return this._sortOrder},getName(){return this._name},getAlwaysShowDropdown(){return this._alwaysShowDropdown},isBlank(){return!this._name}});n().fn.insertAt=function(t,e){return this.each((function(){0===t?e.prepend(this):e.children().eq(t-1).after(this)}))};const k={namespace:[],blockType:null,tabs:null,id:null,level:1,buttons:null,enabled:!0,collapsed:!1,modified:!0,showButtons:!0,showBlockTypeHandle:!1},m={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};function v(t){return t?t.replace(/[&<>"'/]/g,(t=>m[t])):""}function B(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:40;return(t=t||"").length>e?t.slice(0,e-3)+"...":t}const y=s().Base.extend({_templateNs:[],_field:null,_blockType:null,_initialised:!1,_expanded:!0,_enabled:!0,_modified:!0,_initialState:null,_forceModified:!1,_tabs:null,_html:null,_js:null,init(){var t;let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};var i,s;(e=Object.assign({},k,e),this._templateNs=a.parse(e.namespace),this._field=e.field,this._blockType=e.blockType,null!==e.tabs)?this._tabs=null!==(i=null===(s=e.tabs.tabNames)||void 0===s?void 0:s.map((t=>t instanceof h?t:new h({name:t,uid:e.tabs.tabUids[t]}))))&&void 0!==i?i:[]:this._tabs=null;this._blockHtml=e.blockHtml,this._bodyHtml=e.bodyHtml,this._headHtml=e.headHtml,this._id=e.id,this._enabled=e.enabled&&this._blockType.getEnabled(),this._initialEnabled=e.enabled,this._modified=e.modified,this._showButtons=e.showButtons,this._renderOldChildBlocksContainer=!e.blockType.hasChildBlocksUiElement(),this.$container=this._blockHtml?n()(this._blockHtml):this._field.$container.find("[data-neo-b-id=".concat(this._id,"]")),this._uuid=null!==(t=e.uuid)&&void 0!==t?t:this.$container.data("neo-b-uuid");const o=this.$container.find("[data-neo-b]");this.$bodyContainer=o.filter('[data-neo-b="'.concat(this._id,'.container.body"]')),this.$contentContainer=o.filter('[data-neo-b="'.concat(this._id,'.container.content"]')),this.$topbarContainer=o.filter('[data-neo-b="'.concat(this._id,'.container.topbar"]')),this.$topbarLeftContainer=o.filter('[data-neo-b="'.concat(this._id,'.container.topbarLeft"]')),this.$topbarRightContainer=o.filter('[data-neo-b="'.concat(this._id,'.container.topbarRight"]')),this.$handleContainer=o.filter('[data-neo-b="'.concat(this._id,'.container.handle"]')),this.$tabContainer=this.$contentContainer.children("[data-layout-tab]"),this.$menuContainer=o.filter('[data-neo-b="'.concat(this._id,'.container.menu"]')),this.$previewContainer=o.filter('[data-neo-b="'.concat(this._id,'.container.preview"]')),this.$settingsButton=o.filter('[data-neo-b="'.concat(this._id,'.button.actions"]')),this.$togglerButton=o.filter('[data-neo-b="'.concat(this._id,'.button.toggler"]')),this.$enabledInput=o.filter('[data-neo-b="'.concat(this._id,'.input.enabled"]')),this.$levelInput=o.filter('[data-neo-b="'.concat(this._id,'.input.level"]')),this.$collapsedInput=o.filter('[data-neo-b="'.concat(this._id,'.input.collapsed"]')),this.$status=o.filter('[data-neo-b="'.concat(this._id,'.status"]')),this.$sortOrder=o.filter('[data-neo-b="'.concat(this._id,'.sortOrder"]')),this.$form=this.$container.closest("form"),this.resetButtons(e.buttons);let l=!1;if(this._blockType)for(const t of this._blockType.getTabNames()){const e='[data-neo-b-info="'.concat(t,'"]');this.$tabContainer.filter(e).find("ul.errors").length>0&&(l=!0,this.$tabButton.filter(e).addClass("error"))}this.setLevel(e.level),this.toggleExpansion(!!l||!e.collapsed,!1,!1),this.toggleShowButtons(this._showButtons),this.addListener(this.$topbarContainer,"dblclick","@doubleClickTitle"),this.$container.data("block",this)},initUi(){var t;let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(!this._initialised){if(e&&(l().appendBodyHtml(this._bodyHtml),l().appendHeadHtml(this._headHtml),l().initUiElements(this.$contentContainer)),this.$form=this.$container.closest("form"),this.initTabs(),this._settingsMenu=this.$settingsButton.data("trigger")||new(s().DisclosureMenu)(this.$settingsButton),this._settingsMenu.on("show",(()=>{this._field.getBlocks().filter((t=>t.$container.hasClass("active"))).forEach((t=>t.toggleSettingsMenu(!1))),this.$container.addClass("active")})),this._settingsMenu.on("hide",(()=>this.$container.removeClass("active"))),this.$menuContainer=this._settingsMenu.$container,this.addListener(this.$menuContainer.find("[data-action]"),"click",this._handleActionClick),this.addListener(this.$menuContainer.find("[data-action]"),"keydown",this._handleActionKeydown),this.toggleEnabled(this._initialEnabled),this._initialised=!0,null===(t=this._buttons)||void 0===t||t.initUi(),s().requestAnimationFrame((()=>this.updateResponsiveness())),this.$container.on("mousedown",".matrixblock",(function(t){n()(this).addClass("neo-matrixblock")})),this.$container.hasClass("has-errors")&&this.$container.parents(".ni_child-blocks-ui-element").each(((t,e)=>{const i=n()(e).parent(),s=i.closest(".ni_block").data("block"),o=i.index();s.$tabButton.filter(".tab").eq(o).add(s.$tabButton.filter(":not(.tab)").eq(o)).add(s.$container.find("> .ni_block_topbar .tabs_btn")).addClass("has-errors").append('<span data-icon="alert" aria-label="'.concat(l().t("neo","Error"),'"></span>'))})),!this.isNew()){this._initialState={enabled:this._enabled,level:this._level,content:this._getPostData()};const t=()=>this._detectChange(),e=new window.MutationObserver((()=>{setTimeout(t,200),this.getBlockType().isEditableByUser()||this.$container.hasClass("is-disabled-for-user")||this.$container.addClass("is-disabled-for-user")}));e.observe(this.$container[0],{attributes:!0,childList:!0,characterData:!0,subtree:!0}),this.$contentContainer.on("propertychange change click","input, textarea, select, div.redactor-in",t),this.$contentContainer.on("paste input keyup",'input:not([type="hidden"]), textarea, div.redactor-in',t),this._detectChangeObserver=e,this.$menuContainer.find('[data-action="copy"], [data-action="paste"], [data-action="duplicate"]').parent().toggleClass("hidden",!this._blockType.getEnabled())}this.$contentContainer,l().CpFieldInspectPlugin&&l().CpFieldInspectPlugin.addFieldLinks(),this.trigger("initUi")}},initTabs(){const t=this.$container.find("[data-neo-b]");this.$tabsButton=t.filter('[data-neo-b="'.concat(this._id,'.button.tabs"]')),this.$tabsContainer=t.filter('[data-neo-b="'.concat(this._id,'.container.tabs"]')),this.$tabButton=t.filter('[data-neo-b="'.concat(this._id,'.button.tab"]')),this.$tabContainer=this.$contentContainer.children("[data-layout-tab]"),this._tabsMenu=this.$tabsButton.data("trigger")||new(s().DisclosureMenu)(this.$tabsButton),this._tabsMenu.on("show",(()=>this.$container.addClass("active"))),this._tabsMenu.on("hide",(()=>this.$container.removeClass("active"))),this.$tabButton=this.$tabButton.add(this._tabsMenu.$container.find('[data-neo-b="'.concat(this._id,'.button.tab"]'))),this.addListener(this.$tabButton,"click",this["@setTab"]),this.addListener(this.$tabButton,"keydown",this._handleTabKeydown)},getHtml(){return this._blockHtml.replace(/__NEOBLOCK__/g,this._id)},getJs(){return this._bodyHtml.replace(/__NEOBLOCK__/g,this._id)},destroy(){var t;this._initialised&&(null===(t=this.$foot)||void 0===t||t.remove(),clearInterval(this._detectChangeInterval),this._detectChangeObserver&&this._detectChangeObserver.disconnect(),this.trigger("destroy"))},getBlockType(){return this._blockType},getId(){return this._id},getUuid(){return this._uuid},getDuplicatedBlockId(){var t,e;return null!==(t=null===(e=this.$form.data("elementEditor"))||void 0===e?void 0:e.duplicatedElements[this._id])&&void 0!==t?t:this._id},isTopLevel(){return 1===this._level},getLevel(){return this._level},setLevel(t){this._level=0|t,this.$levelInput.val("0".concat(this._level)),this.$container.toggleClass("is-level-odd",!!(this._level%2)),this.$container.toggleClass("is-level-even",!(this._level%2))},setModified(t){this._modified=t},getButtons(){return this._buttons},getSiteId(){if(!this._siteId){const t=this.$form.find('input[name="siteId"]');this._siteId=t.val()}return this._siteId},getContent(){const t=this._getPostData(),e={},i=(t,i)=>{let s=e;for(let e=0;e<t.length-1;e++){const i=t[e];n().isPlainObject(s[i])||Array.isArray(s[i])||(s[i]={}),s=s[i]}s[t[t.length-1]]=i};for(const e of Object.keys(t)){const n=a.parse(e).slice(this._templateNs.length+1);if(!n.length)continue;i(n,t[e])}return e},getParent(){var t;let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;null!==(t=e)&&void 0!==t||(e=this._field.getBlocks());const n=this.getLevel();let i=e.indexOf(this),s=null;if(i>=0&&n>1)for(;null===s&&i>0;){const t=e[--i];t.getLevel()===n-1&&(s=t)}return s},getChildren(){var t;let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;null!==(t=e)&&void 0!==t||(e=this._field.getBlocks());const i=this.getLevel();let s=e.indexOf(this);const o=[];if(s>=0){let t=e[++s];for(;t&&t.getLevel()>i;){const l=t.getLevel();(n?l>i:l===i+1)&&o.push(t),t=e[++s]}}return o},getSiblings(){var t;let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return null!==(t=e)&&void 0!==t||(e=this._field.getBlocks()),this.isTopLevel()?e.filter((t=>t.isTopLevel())):this.getParent(e).getChildren(e)},getField(){return this._field},updatePreview(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;t="boolean"==typeof t&&t;const e=this.$childrenContainer.find(".field"),i=this.$contentContainer.find(".field").add(e),o=[];i.each((function(){const e=n()(this),i=e.children(".input"),a=e.data("type"),r=e.children(".heading").children("label").text();if(null===a)return;let c=!1;switch(a){case"craft\\fields\\Assets":{const e=[],s=i.find(".element");s.each((function(){const i=n()(this),o=i.find(".elementthumb");let l=o.children("img").prop("srcset");if(l||(l=o.data("srcset")),e.push('<img sizes="30px" srcset="'.concat(l,'">')),!t&&1===s.length){const t=i.find(".title").text();e.push(v(B(t)))}})),c=e.join(" ")}break;case"craft\\fields\\Categories":case"craft\\fields\\Entries":case"craft\\fields\\Tags":case"craft\\fields\\Users":{const t=[];i.find(".element").each((function(){const e=n()(this).find(".title, .label").eq(0).text();t.push(v(B(e)))})),c=t.join(", ")}break;case"craft\\fields\\Checkboxes":{const t=[];i.find('input[type="checkbox"]').each((function(){if(this.checked){const e=n()(this).prop("id"),s=i.find('label[for="'.concat(e,'"]')).text();t.push(v(B(s)))}})),c=t.join(", ")}break;case"craft\\fields\\Color":{const t=i.find('input[type="color"]').val(),e=i.find('input[type="text"]').val(),n=i.find("div.colorhex").text();let s=null;s=t&&e?"background-color: ".concat(t):!t&&e?"background-color: ".concat(e):n?"background-color: ".concat(n):"background-image: repeating-linear-gradient(-45deg, transparent, transparent 2px, #777 2px, #777 3px)",c='<div class="preview_color" style="'.concat(s,'"></div>')}break;case"craft\\fields\\Date":{const t=v(i.find(".datewrapper input").val()),e=v(i.find(".timewrapper input").val());c=t&&e?t+" "+e:t||e}break;case"craft\\fields\\Dropdown":c=v(B(i.find("select").children(":selected").text()));break;case"craft\\fields\\Email":c=v(B(i.children('input[type="email"]').val()));break;case"craft\\fields\\Lightswitch":{const t=!!i.find("input").val();c='<span class="status'.concat(t?" live":"",'"></span>')+v(B(r))}break;case"craft\\fields\\MultiSelect":case"ttempleton\\categorygroupsfield\\fields\\CategoryGroupsField":{const t=[];i.find("select").children(":selected").each((function(){t.push(n()(this).text())})),c=v(B(t.join(", ")))}break;case"craft\\fields\\Number":case"craft\\fields\\PlainText":c=v(B(i.children('input[type="text"], textarea').val()));break;case"craft\\fields\\RadioButtons":c=v(B(i.find('input[type="radio"]:checked').closest("label").text()));break;case"craft\\redactor\\Field":case"spicyweb\\tinymce\\fields\\TinyMCE":c=v(B(l().getText(i.find("textarea").val())));break;case"craft\\ckeditor\\Field":c=v(B(l().getText(i.find('[role="textbox"]').html())));break;case"craft\\fields\\Url":c=v(B(i.children('input[type="url"]').val()));break;case"craft\\fields\\Matrix":case"verbb\\supertable\\fields\\SuperTableField":{const t=e.find(".field").find('input[type!="hidden"], select, textarea, .label'),i=[];t.each((function(){const t=n()(this);let e=null;t.is("input, textarea")?e=l().getText(s().getInputPostVal(t)):t.is("select")?e=t.find("option:selected").text():t.hasClass("label")&&(e=t.text()),e&&i.push(B(e))})),c=v(i.join(", "))}break;case"typedlinkfield\\fields\\LinkField":case"presseddigital\\linkit\\fields\\LinkitField":{const t=[],e=i.find("select").children(":selected").first(),n=i.find('.linkfield--typeOption:not(.hidden), [class^="linkit--"]:not(.hidden)'),s=n.find('input[type!="hidden"]').val(),o=n.find(".element"),l=i.find('.field[id*="customText"] input, .linkit--customText input').val();if(t.push(B(e.text())),s&&t.push(B(s)),o.length>0){const e=o.find(".title, .label").eq(0).text();t.push(B(e))}l&&t.push(B(l)),c=v(t.join(", "))}break;case"luwes\\codemirror\\fields\\CodeMirrorField":{const t=[];e.find(".CodeMirror-line > span").each((function(){t.push(n()(this).text())})),c=v(t.join(" "));break}case"rias\\positionfieldtype\\fields\\Position":c=v(i.find(".btn.active").prop("title"));break;case"wrav\\oembed\\fields\\OembedField":c=v(B(i.children("input").val()))}c&&o.length<10&&o.push('<span class="preview_section">',c,"</span>")})),this.$previewContainer.html(o.join(""))},isNew(){return/^new/.test(this.getId())},isSelected(){return this.$container.hasClass("is-selected")},collapse(t,e){this.toggleExpansion(!1,t,e)},expand(t,e){this.toggleExpansion(!0,t,e)},toggleExpansion(t,e,n){if(t="boolean"==typeof t?t:!this._expanded,e="boolean"!=typeof e||e,n=!s().prefersReducedMotion()&&("boolean"!=typeof n||n),t!==this._expanded){this._expanded=t,this._expanded||this.updatePreview();const i=this.$menuContainer.find('[data-action="expand"]').parent(),s=this.$menuContainer.find('[data-action="collapse"]').parent();this.$collapsedInput.val(this._expanded?"":"1"),this.$container.toggleClass("is-expanded",this._expanded).toggleClass("is-collapsed",!this._expanded),i.toggleClass("hidden",this._expanded),s.toggleClass("hidden",!this._expanded),this.$previewContainer.toggleClass("hidden",this._expanded);const o={opacity:1,height:(0|this.$contentContainer.outerHeight())+(0|this.$childrenContainer.outerHeight())},l={opacity:0,height:0},a={opacity:"",height:""};n?this.$bodyContainer.css(this._expanded?l:o).velocity(this._expanded?o:l,"fast",(t=>{this._expanded&&this.$bodyContainer.css(a)})):this.$bodyContainer.css(this._expanded?a:l),e&&this.saveExpansion(),this.trigger("toggleExpansion",{expanded:this._expanded})}},isExpanded(){return this._expanded},saveExpansion(){if(!this.isNew()){var t;const e=null!==(t=this.$form.data("elementEditor"))&&void 0!==t&&t.settings.isProvisionalDraft?this.getDuplicatedBlockId():this.getId(),n={expanded:this.isExpanded()?1:0,blockId:e,siteId:this.getSiteId()};l().queue.push((()=>new Promise(((t,e)=>{l().sendActionRequest("POST","neo/input/save-expansion",{data:n}).then(t).catch(e)}))))}},disable(){this.toggleEnabled(!1)},enable(){this.toggleEnabled(!0)},toggleEnabled(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!this._enabled;const e=this._enabled!==t;this._enabled=t;const n=this._blockType.getEnabled(),i=this._enabled&&n,s=this.$menuContainer.find('[data-action="enable"]').parent(),o=this.$menuContainer.find('[data-action="disable"]').parent();this.$container.toggleClass("is-enabled",i).toggleClass("is-disabled",!i),this.$status.toggleClass("hidden",i),s.toggleClass("hidden",this._enabled||!n),o.toggleClass("hidden",!this._enabled||!n),this.$enabledInput.val(this._enabled?"1":""),e&&this.trigger("toggleEnabled",{enabled:this._enabled})},isEnabled(){return this._enabled},toggleShowButtons(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!this._showButtons;this.$buttonsContainer.toggleClass("hidden",!t),this.$childrenWarningsContainer.toggleClass("hidden",t)},selectTab(t){this.$tabButton.removeClass("is-selected"),this.$tabContainer.addClass("hidden");const e=this.$tabButton.filter('[data-neo-b-info="'.concat(t,'"]')).addClass("is-selected"),n=e.attr("data-neo-b-tabuid"),i=this.$tabContainer.filter('[data-layout-tab="'.concat(n,'"]')).removeClass("hidden");this.$tabsButton.text(t),l().ElementThumbLoader.retryAll(),this.trigger("selectTab",{tabName:t,$tabButton:e,$tabContainer:i})},updateResponsiveness(){var t,e;const n=s().isMobileBrowser();null!==(t=this._topbarLeftWidth)&&void 0!==t||(this._topbarLeftWidth=this.$topbarLeftContainer.width()-(this._expanded?0:this.$previewContainer.width())-(n?this.$handleContainer.width():0)),null!==(e=this._topbarRightWidth)&&void 0!==e||(this._topbarRightWidth=this.$topbarRightContainer.width());const i=this.$topbarContainer.width()<this._topbarLeftWidth+this._topbarRightWidth;this.$handleContainer.toggleClass("hidden",n),this.$tabsContainer.toggleClass("invisible",i),this.$tabsButton.toggleClass("invisible",!i)},updateActionsMenu(){var t,e;const n=this._field.getBlocks(),i=null===(t=this.getParent())||void 0===t?void 0:t.getBlockType();let s=null!==(e=null==i?void 0:i.getChildBlocks())&&void 0!==e?e:this._field.getBlockTypes(!0);!0===s||"*"===s?s=this._field.getBlockTypes(!1):Array.isArray(s)&&(s=s.map((t=>"string"==typeof t?this._field.getBlockTypeByHandle(t):t)).filter((t=>void 0!==t))),s=s.filter((t=>t.isCreatableByUser()));const o=this._field.getName(),l=this._field.getMaxBlocks(),a=1===this._level?this._field.getMaxTopBlocks():0,r=!s||0===s.length,c=this.getBlockType(),d=n.filter((t=>t.getBlockType().getHandle()===c.getHandle())),h=c.getMaxBlocks(),u=this.getSiblings(n),p=n.filter((t=>t.isTopLevel())).length,g=l>0&&n.length>=l||a>0&&p>=a||!1,b=g||r,f=h>0&&d.length>=h;let _=g||f;const k=JSON.parse(window.localStorage.getItem("neo:copy:".concat(o))||"{}");let m=g||!k.blocks||!k.field||k.field!==o;const v=this.getParent(n);if((!m||!_)&&v){const t=v.getBlockType().getMaxChildBlocks();if(t>0){var B,y;const e=v.getChildren(n).length,i=null!==(B=null===(y=k.blocks)||void 0===y?void 0:y.length)&&void 0!==B?B:0;m||(m=e+i>t),_||(_=e>=t)}}if(!m||!_){const t=this.getBlockType().getMaxSiblingBlocks();if(t>0){const e=t=>Object.prototype.hasOwnProperty.call(t,"type")?t.type===this.getBlockType().getId():"function"==typeof t.getBlockType&&t.getBlockType().getHandle()===this.getBlockType().getHandle(),n=u.filter(e,this).length,i=k.blocks?k.blocks.filter(e,this).length:0;m||(m=n+i>t),_||(_=n>=t)}}if(!m){const t=n.reduce(((t,e)=>{const n=e.getBlockType(),i=n.getId(),s=t[i]||{blockType:n,count:0};return s.count++,t[i]=s,t}));for(const e of k.blocks){const n=t[e.type];if(n){const t=n.blockType,e=n.count,i=t.getMaxBlocks();m||(m=i>0&&e>=i)}1===e.level&&(m||(m=!s.find((t=>t.getId()===e.type))))}}const C=u.indexOf(this),$=C<=0,T=[-1,u.length-1].includes(C);this.$menuContainer.find('[data-action="moveUp"]').parent().toggleClass("hidden",$),this.$menuContainer.find('[data-action="moveDown"]').parent().toggleClass("hidden",T),this.$menuContainer.find('[data-action="duplicate"]').toggleClass("disabled",_),r?(this.$menuContainer.find('[data-action="add"]').parent().toggleClass("hidden",b),this.$menuContainer.find('[data-action="paste"]').parent().toggleClass("hidden",m)):(this.$menuContainer.find('[data-action="add"]').toggleClass("disabled",b),this.$menuContainer.find('[data-action="paste"]').toggleClass("disabled",m)),this.$menuContainer.children("hr").toggleClass("hidden",0===this.$menuContainer.children("ul:last-child").children("li:not(.hidden)").length)},resetButtons(t){this.$blocksContainer=this.$container.find('[data-neo-b="'.concat(this._id,'.container.blocks"]')),this.$buttonsContainer=this.$container.find('[data-neo-b="'.concat(this._id,'.container.buttons"]')),this.$childrenContainer=this.$container.find('[data-neo-b="'.concat(this._id,'.container.children"]')),this.$childrenWarningsContainer=this.$container.find('[data-neo-b="'.concat(this._id,'.container.childrenWarnings"]')),this.$collapsedChildrenContainer=this.$container.find('[data-neo-b="'.concat(this._id,'.container.collapsedChildren"]')),this._buttons=null!=t?t:new this._field.ButtonClass({$ownerContainer:this.$container,field:this._field,items:this._blockType.getChildBlockItems(this._field.getItems()),maxBlocks:this._field.getMaxBlocks()}),this._buttons&&(this._buttons.on("newBlock",(t=>this.trigger("newBlock",Object.assign(t,{level:this.getLevel()+1})))),this.$buttonsContainer.append(this._buttons.$container),null===this._buttons.$ownerContainer&&(this._buttons.$ownerContainer=this.$container),this._initialised&&this._buttons.initUi())},namespaceId(t){a.enter(this._templateNs);const e="".concat(a.toString("-"),"-").concat(l().formatInputId(t));return a.leave(),e},toggleSettingsMenu(t){var e;null!==(e=t)&&void 0!==e||(t=!this._settingsMenu.isExpanded()),t?this._settingsMenu.show():this._settingsMenu.hide()},_handleActionClick(t){t.preventDefault(),this["@settingSelect"](t)},_handleActionKeydown(t){t.keyCode===s().SPACE_KEY&&(t.preventDefault(),this["@settingSelect"](t))},_handleTabKeydown(t){t.keyCode===s().SPACE_KEY&&this["@setTab"](t)},_detectChange(){const t=this.$form.data("elementEditor");if(null!=t&&t.enableAutosave&&t.settings.draftId&&(this.setModified(!0),this._forceModified=!0),!this._forceModified){const t=this._initialState,e=this._getPostData(),n=!l().compare(e,t.content,!1)||t.enabled!==this._enabled||t.level!==this._level;n!==this._modified&&this.setModified(n)}this.trigger("change")},_getPostData(){const t=s().getPostData(this.$contentContainer),e=Object.keys(t).filter((t=>!t.startsWith("fields[".concat(this._field.getName(),"][blocks][").concat(this._id,"]"))));for(const n of e)delete t[n];return t},"@settingSelect"(t){this._settingsMenu.hide();const e=n()(t.target);if(!e.hasClass("disabled"))switch(e.attr("data-action")){case"collapse":this.collapse();break;case"expand":this.expand();break;case"disable":this.disable(),this.collapse();break;case"enable":this.enable(),this.expand();break;case"moveUp":this.trigger("moveUpBlock",{block:this});break;case"moveDown":this.trigger("moveDownBlock",{block:this});break;case"delete":this.trigger("removeBlock",{block:this});break;case"add":this.trigger("addBlockAbove",{block:this});break;case"copy":this.trigger("copyBlock",{block:this});break;case"paste":this.trigger("pasteBlock",{block:this});break;case"duplicate":this.trigger("duplicateBlock",{block:this})}},"@doubleClickTitle"(t){t.preventDefault();const e=n()(t.target).parent(),i=e.closest(this.$topbarLeftContainer).length>0,s=e.closest(this.$topbarRightContainer).length>0;var o,l;i||s||(null===(o=this.$form.data("elementEditor"))||void 0===o||o.pause(),this.toggleExpansion(),null===(l=this.$form.data("elementEditor"))||void 0===l||l.resume())},"@setTab"(t){t.preventDefault(),this._tabsMenu.hide();const e=n()(t.currentTarget).attr("data-neo-b-info");this.selectTab(e)}});function C(t,e,n){return(e=function(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var i=n.call(t,e||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}const $={$ownerContainer:null,blockTypes:[],groups:[],items:null,maxBlocks:0,maxTopBlocks:0,blocks:null};class T{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};C(this,"_blockTypes",[]),C(this,"_blockTypeGroups",[]),t=Object.assign({},$,t),t.items?(this._items=Array.from(t.items),this._blockTypes=this._items.filter((t=>"blockType"===t.getType())),this._blockTypeGroups=this._items.filter((t=>"group"===t.getType()))):(this._blockTypes=Array.from(t.blockTypes),this._blockTypeGroups=Array.from(t.groups),this._items=[...this._blockTypes,...this._blockTypeGroups].sort(((t,e)=>t.getSortOrder()-e.getSortOrder()))),this.$ownerContainer=t.$ownerContainer,this._field=t.field,this._maxBlocks=0|t.maxBlocks,this._maxTopBlocks=0|t.maxTopBlocks,this.$container=this.renderButtons();const e=this.$container.find("[data-neo-bn]");this.$buttonsContainer=e.filter('[data-neo-bn="container.buttons"]'),this.$menuContainer=e.filter('[data-neo-bn="container.menu"]'),this.$blockButtons=e.filter('[data-neo-bn="button.addBlock"]'),this.$groupButtons=e.filter('[data-neo-bn="button.group"]'),t.blocks&&this.updateState(t.blocks)}renderButtons(){var t;const e=null!==(t=this.$ownerContainer)&&void 0!==t&&t.hasClass("ni_block")?this.$ownerContainer.attr("class").match(/ni_block--([^\s]+)/)[1]:null,i=null!==e&&!this.getField().getBlockTypeByHandle(e).getGroupChildBlockTypes(),s=[];let o=[],a=null,r=!0;const c=()=>{s.push('\n          <div class="btn dashed'.concat(r?" add icon":"",' menubtn" data-neo-bn="button.group">\n            ').concat(a.getName(),'\n          </div>\n          <div class="menu">\n            <ul>').concat(o.join(""),"\n            </ul>\n          </div>")),r=!1,o=[]};s.push('\n      <div class="ni_buttons">\n        <div class="btngroup" data-neo-bn="container.buttons">');for(let t=0;t<this._items.length;t++){const e=this._items[t],n=e.getType();if("blockType"===n){if(!e.getEnabled()||!e.isCreatableByUser())continue;const t=e.getDescription()?' title="'.concat(e.getDescription(),'"'):"";null!==a?o.push("\n            <li>\n              <a".concat(t,' aria-label="').concat(e.getName(),'" data-neo-bn="button.addBlock" ').concat(T.BUTTON_INFO,'="').concat(e.getHandle(),'">').concat(e.getName(),"</a>\n            </li>")):(s.push("\n          <button".concat(t,' aria-label="').concat(e.getName(),'" class="btn dashed').concat(r?" add icon":"",'" data-neo-bn="button.addBlock" ').concat(T.BUTTON_INFO,'="').concat(e.getHandle(),'">\n            ').concat(e.getName(),"\n          </button>")),r=!1)}else"group"===n&&(null!==a&&o.length>0&&c(),a=e.isBlank()||!e.getAlwaysShowDropdown()&&(t+2>=this._items.length||"group"===this._items[t+2].getType())||i?null:e)}null!==a&&o.length>0&&c(),s.push('\n        </div>\n        <div class="btn dashed add icon menubtn hidden" data-neo-bn="container.menu">\n          '.concat(l().t("neo","Add a block"),"\n        </div>")),a=null;let d=!1;s.push('\n        <div class="menu">\n          <ul>');for(const t of this._items){const e=t.getType();if("blockType"===e){if(!t.getEnabled()||!t.isCreatableByUser())continue;null===a||d||(d=!0,s.push("\n              <h6>".concat(a.getName(),'</h6>\n              <ul class="padded">')));const e=t.getDescription()?' title="'.concat(t.getDescription(),'"'):"";s.push("\n            <li>\n              <a".concat(e,' aria-label="').concat(t.getName(),'" data-neo-bn="button.addBlock" ').concat(T.BUTTON_INFO,'="').concat(t.getHandle(),'">\n                ').concat(t.getName(),"\n              </a>\n            </li>"))}else"group"===e&&((null===a||d)&&s.push("\n              </ul>"),d=!1,a=t.isBlank()||i?null:t,null===a&&s.push("\n              <ul>"))}return s.push("\n          </ul>\n        </div>\n      </div>"),n()(s.join(""))}getField(){return this._field}getBlockTypes(){return Array.from(this._blockTypes)}getBlockTypeGroups(){return Array.from(this._blockTypeGroups)}getBlockTypeByButton(t){const e=t.attr(T.BUTTON_INFO);return this._blockTypes.find((t=>t.getHandle()===e))}updateState(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;e="boolean"!=typeof e||e;const s=this,o=t.filter((t=>t.isTopLevel())).length,l=this._maxBlocks>0&&t.length>=this._maxBlocks,a=this._maxTopBlocks>0&&o>=this._maxTopBlocks,r=l||a||!e;this.$blockButtons.each((function(){const e=n()(this);let o=r;if(!o){const n=t=>t.getBlockType().getHandle()===l.getHandle(),l=s.getBlockTypeByButton(e),a=t.filter(n),r=l.getMaxBlocks(),c=l.getMaxSiblingBlocks(),d=null!==i?i.getChildren(t).filter(n):t.filter((t=>t.isTopLevel()&&t.getBlockType().getHandle()===l.getHandle()));o||(o=r>0&&a.length>=r||c>0&&d.length>=c)}e.toggleClass("disabled",o)})),this.$groupButtons.each((function(){const t=n()(this),e=t.data("menubtn");let i=r;if(!i&&e){const t=e.menu.$options;i=t.length===t.filter(".disabled").length}t.toggleClass("disabled",i)}))}updateResponsiveness(){}}C(T,"BUTTON_INFO","data-neo-bn-info");const x=s().Base.extend({init(t){this._buttons=t,this.$container=this._buttons.$container,this.addListener(this._buttons.$blockButtons,"activate","@newBlock")},initUi(){this._buttons.initUi()},getBlockTypes(){return this._buttons.getBlockTypes()},getGroups(){return this._buttons.getBlockTypeGroups()},getMaxBlocks(){return this._maxBlocks},updateButtonStates(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._buttons.updateState(t,e,n)},updateState(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._buttons.updateState(t,e,n)},updateResponsiveness(){this._buttons.updateResponsiveness()},getBlockTypeByButton(t){return this._buttons.getBlockTypeByButton(t)},"@newBlock"(t){const e=n()(t.currentTarget).attr(T.BUTTON_INFO),i=this._buttons.getBlockTypes().find((t=>t.getHandle()===e));this.trigger("newBlock",{blockType:i})}});class w extends T{initUi(){if(n()(".menubtn",this.$container).menubtn(),this.updateResponsiveness(),0===this.$buttonsContainer.children().length){const t=this.$container.parent(),e=t.parent(),n=e.children(".ni_blocks");0===n.length||0===n.children().length?e.addClass("hidden"):t.addClass("hidden")}}updateResponsiveness(){this._buttonsContainerWidth||(this._buttonsContainerWidth=this.$buttonsContainer.width());const t=this.$container.width()<this._buttonsContainerWidth;this.$buttonsContainer.toggleClass("hidden",t),this.$menuContainer.toggleClass("hidden",!t)}}const I=x.extend({init(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.base(new w(t))}});class E extends T{renderButtons(){var t;const e=null!==(t=this.$ownerContainer)&&void 0!==t&&t.hasClass("ni_block")?this.$ownerContainer.attr("class").match(/ni_block--([^\s]+)/)[1]:null,i=null!==e&&!this.getField().getBlockTypeByHandle(e).getGroupChildBlockTypes(),s=[];let o=null;s.push('\n        <div class="ni_buttons">\n          <div class="btn dashed add icon menubtn" data-neo-bn="container.menu">\n            '.concat(l().t("neo","Add a block"),"\n          </div>")),o=null;let a=!1;s.push('\n          <div class="menu ni_newblockgrid" data-neo-bn="container.buttons">');for(const t of this._items){const e=t.getType();if("blockType"===e){var r,c;if(!t.getEnabled()||!t.isCreatableByUser())continue;a||(a=!0,null!==o&&s.push("\n            <h6>".concat(o.getName(),"</h6>")),s.push('\n            <ul class="padded">'));const e=t.getDescription()?' title="'.concat(t.getDescription(),'"'):"",n="fields-ni-icon-".concat(this.getField().getName(),"-").concat(t.getHandle()),i=null!==(r=(null===(c=this._field)||void 0===c?void 0:c.$container.closest("form").find("#".concat(n)).length)>0)&&void 0!==r&&r;s.push("\n              <li>\n                <a".concat(e,' aria-label="').concat(t.getName(),'" data-neo-bn="button.addBlock" ').concat(T.BUTTON_INFO,'="').concat(t.getHandle(),'">')),i?s.push('\n                  <svg class="ni_newblockgrid_icon">\n                    <use href="#'.concat(n,'"></use>\n                  </svg>')):s.push('\n                  <div class="ni_newblockgrid_icon defaulticon">\n                  </div>'),s.push("\n                  <span>".concat(t.getName(),"</span>\n                </a>\n              </li>"))}else"group"===e&&(a&&s.push("\n            </ul>"),a=!1,o=t.isBlank()||i?null:t)}return s.push("\n          </ul>\n        </div>\n      </div>"),n()(s.join(""))}initUi(){if(n()(".menubtn",this.$container).menubtn(),this.updateResponsiveness(),0===this.$buttonsContainer.find('[data-neo-bn="button.addBlock"]').length){const t=this.$container.parent(),e=t.parent(),n=e.children(".ni_blocks");0===n.length||0===n.children().length?e.addClass("hidden"):t.addClass("hidden")}}}const O=x.extend({init(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.base(new E(t))}});class N extends T{renderButtons(){var t;const e=null!==(t=this.$ownerContainer)&&void 0!==t&&t.hasClass("ni_block")?this.$ownerContainer.attr("class").match(/ni_block--([^\s]+)/)[1]:null,i=null!==e&&!this.getField().getBlockTypeByHandle(e).getGroupChildBlockTypes(),s=[];let o=null;s.push('\n      <div class="ni_buttons">\n        <div class="btn dashed add icon menubtn" data-neo-bn="container.menu">\n          '.concat(l().t("neo","Add a block"),"\n        </div>"));let a=!1;s.push('\n        <div class="menu ni_newblocklist" data-neo-bn="container.buttons">');for(const t of this._items){const e=t.getType();if("blockType"===e){var r,c;if(!t.getEnabled()||!t.isCreatableByUser())continue;a||(a=!0,null!==o&&s.push("\n            <h6>".concat(o.getName(),"</h6>")),s.push('\n            <ul class="padded">'));const e=t.getDescription()?' title="'.concat(t.getDescription(),'"'):"",n="fields-ni-icon-".concat(this.getField().getName(),"-").concat(t.getHandle()),i=null!==(r=(null===(c=this._field)||void 0===c?void 0:c.$container.closest("form").find("#".concat(n)).length)>0)&&void 0!==r&&r;s.push("\n              <li>\n                <a".concat(e,' class="flex" aria-label="').concat(t.getName(),'" data-neo-bn="button.addBlock" ').concat(T.BUTTON_INFO,'="').concat(t.getHandle(),'">')),i?s.push('\n                  <svg class="ni_newblocklist_icon">\n                    <use href="#'.concat(n,'"></use>\n                  </svg>')):s.push('\n                  <div class="ni_newblocklist_icon defaulticon">\n                  </div>'),s.push("\n                  <span>".concat(t.getName(),"</span>\n                </a>\n              </li>"))}else"group"===e&&(a&&s.push("\n            </ul>"),a=!1,o=t.isBlank()||i?null:t)}return s.push("\n          </ul>\n        </div>\n      </div>"),n()(s.join(""))}initUi(){if(n()(".menubtn",this.$container).menubtn(),this.updateResponsiveness(),0===this.$buttonsContainer.find('[data-neo-bn="button.addBlock"]').length){const t=this.$container.parent(),e=t.parent(),n=e.children(".ni_blocks");0===n.length||0===n.children().length?e.addClass("hidden"):t.addClass("hidden")}}}const S=x.extend({init(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.base(new N(t))}}),L={name:null,namespace:[],blockTypes:[],groups:[],blocks:[],inputId:null,maxBlocks:0,maxTopBlocks:0,minLevels:0,maxLevels:0,ownerId:null},M=s().Base.extend({_templateNs:[],_name:null,_siteId:null,_visibleLayoutElements:{},_newBlockCount:0,init(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t=Object.assign({},L,t),this._templateNs=a.parse(t.namespace),this._blockTypes=[],this._groups=t.groups.map((t=>new _(t))),this._blocks=[],this._id=t.id,this._name=t.name,this._minBlocks=t.minBlocks,this._maxBlocks=t.maxBlocks,this._maxTopBlocks=t.maxTopBlocks,this._minLevels=t.minLevels,this._maxLevels=t.maxLevels,this._ownerId=t.ownerId,this._showBlockTypeHandles=t.showBlockTypeHandles;const e=!s().prefersReducedMotion();switch(this._$spinner=n()('<div class="ni_spinner">'.concat(e?'<div class="spinner"></div>':l().t("neo","Loading"),"</div>")),t.newBlockMenuStyle){case"grid":this.ButtonClass=O;break;case"list":this.ButtonClass=S;break;default:this.ButtonClass=I}const i=n()('[name="setId"], [name="entryId"], [name="categoryId"]');i.length&&(this._ownerId=i.val()),this.$container=n()("#"+t.inputId);const o={};this._groups.forEach((t=>{o[t.getId()]=!0}));const r={};for(const e of t.blockTypes)if(null===e.groupId||void 0!==o[e.groupId]){const t=new b(Object.assign({field:this},e));this._blockTypes.push(t),r[t.getHandle()]=t}this.$form=this.$container.closest("form"),this._siteId=this.$form.find('input[name="siteId"]').val();const d=this.$container.find("[data-neo]");if(this.$blocksContainer=d.filter('[data-neo="container.blocks"]'),this.$buttonsContainer=d.filter('[data-neo="container.buttons"]'),this._buttons=new this.ButtonClass({$ownerContainer:this.$container,field:this,blockTypes:this.getBlockTypes(!0),groups:this.getGroups(),maxBlocks:this.getMaxBlocks(),maxTopBlocks:this.getMaxTopBlocks()}),this.$buttonsContainer.append(this._buttons.$container),this._buttons.on("newBlock",(t=>this["@newBlock"](t))),this._buttons.initUi(),this._blockSort=new c({container:this.$blocksContainer,handle:'[data-neo-b$=".button.move"]',maxTopBlocks:this.getMaxTopBlocks(),filter:()=>this._blockSort.$targetItem.hasClass("is-selected")?this.blockSelect.getSelectedItems():this._blockSort.$targetItem,collapseDraggees:!0,magnetStrength:4,helperLagBase:1.5,helperOpacity:.9,onDragStart:()=>{var t;null===(t=this.$form.data("elementEditor"))||void 0===t||t.pause()},onDragStop:()=>{var t;null===(t=this.$form.data("elementEditor"))||void 0===t||t.resume(),this._updateBlockOrder(),this._updateButtons()}}),this.blockSelect=new(s().Select)(this.$blocksContainer,null,{multi:!0,vertical:!0,handle:'> .ni_block_topbar [data-neo-b$=".select"]',checkboxMode:!0,selectedClass:"is-selected sel"}),this.$blocksContainer.find(".ni_block").each(((t,e)=>{const i=n()(e),s={};s.id=i.attr("data-neo-b-id"),s.sortOrder=t,s.collapsed=i.hasClass("is-collapsed"),s.enabled=!!i.find('[data-neo-b="'.concat(s.id,'.input.enabled"]')).val(),s.level=parseInt(i.find('[data-neo-b="'.concat(s.id,'.input.level"]')).val()),s.field=this,s.namespace=[...this._templateNs,s.id];const o=i.find('[data-neo-b="'.concat(s.id,'.input.type"]')).val(),l=r[o];if(void 0===l)return void i.remove();s.blockType=l,s.showButtons=!this.atMaxLevels(s.level);const a=new y(s);a.initUi(!1),this._setBlockEvents(a),i.data("block",a),this._blocks.push(a),this._blockSort.addBlock(a),this.blockSelect.addItems(a.$container)})),this._updateBlockChildren(),this._updateButtons(),this._minBlocks>0){const t=this._minBlocks-this._blocks.length,e=this.getBlockTypes(!0);if(1===e.length&&t>0)for(let t=this._blocks.length;t<this._minBlocks;t++)this["@newBlock"]({blockType:e[0],createChildBlocks:!1,index:t,level:1})}this.addListener(document,"visibilitychange.input",(()=>this._updateButtons())),this.addListener(this.$container,"resize",(()=>this.updateResponsiveness()));const h="function"==typeof this.$form.data("serializer")?this.$form.data("serializer")():this.$form.serialize();this.$form.data("initialSerializedValue",h),this._setMatrixClassErrors(),this._setBlockTypeClassErrors(),this._blocks.filter((t=>!t.isExpanded())).forEach((t=>t.updatePreview())),this._registerDynamicBlockConditions(),this.trigger("afterInit")},getId(){return this._id},getName(){return this._name},updateResponsiveness(){var t;for(const t of this._blocks){var e;t.updateResponsiveness(),null===(e=t.getButtons())||void 0===e||e.updateResponsiveness()}this._buttons.updateResponsiveness(),null===(t=this._tempButtons)||void 0===t||t.updateResponsiveness()},addBlock(t){var e;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,l=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];this._newBlockCount++,null===(e=this.$form.data("elementEditor"))||void 0===e||e.pause();const a=this._blocks.length;n=n>=0?Math.max(0,Math.min(n,a)):a,o=!s().prefersReducedMotion()&&("boolean"!=typeof o||o);const r=n>0&&this._blocks[n-1],c=n<a&&this._blocks[n];if(r){const e=c?c.getLevel():1,s=r.getLevel()+(r.getBlockType().isParent()?1:0);i=Math.max(e,Math.min(i,s));const o=this._findPrevBlockOnLevel(n,i);o?o.$container.after(t.$container):r.$blocksContainer.prepend(t.$container)}else this.$blocksContainer.prepend(t.$container);t.setLevel(i),t.$container.data("block",t),this._blocks.push(t),this._blockSort.addBlock(t),this.blockSelect.addItems(t.$container),t.initUi(),this._setBlockEvents(t),this._destroyTempButtons(),this._updateBlockOrder(),this._updateBlockChildren(),this._updateButtons();const d={};t.$contentContainer.children("[data-layout-tab]").each(((t,e)=>{const n=e.getAttribute("data-layout-tab");d[n]=[],e.querySelectorAll(":scope > [data-layout-element]:not([data-layout-element-placeholder])").forEach((t=>{d[n].push(t.getAttribute("data-layout-element"))}))})),this._visibleLayoutElements[t.getId()]=d;const h=()=>{var e;if(l){const e=t.getBlockType(),s=e.getMinChildBlocks();if(s>0){let t=e.getChildBlocks();if("*"===t&&(t=this.getBlockTypes()),1===t.length){const e=this.getBlockTypeByHandle(t[0]);for(let t=0;t<s;t++)this["@newBlock"]({blockType:e,createChildBlocks:!1,index:n+t+1,level:i+1})}}}null===(e=this.$form.data("elementEditor"))||void 0===e||e.resume()};o?t.$container.css({opacity:0,marginBottom:-t.$container.outerHeight()}).velocity({opacity:1,marginBottom:10},"fast",(e=>s().requestAnimationFrame((()=>{s().scrollContainerToElement(t.$container),h()})))):h(),this.trigger("addBlock",{block:t,index:n})},removeBlock(t){var e;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;null===(e=this.$form.data("elementEditor"))||void 0===e||e.pause(),n=!s().prefersReducedMotion()&&("boolean"!=typeof n||n),i="boolean"==typeof i&&i;const o=this._findChildBlocks(this._blocks.indexOf(t));for(const t of o)this.removeBlock(t,!0,!0);t.off(".input"),this._blocks=this._blocks.filter((e=>e!==t)),this._blockSort.removeItems(t.$container),this.blockSelect.removeItems(t.$container),this._destroyTempButtons(),this._updateButtons();const l=()=>{var e;t.$container.remove(),this._updateBlockChildren(),null===(e=this.$form.data("elementEditor"))||void 0===e||e.resume()};n?t.$container.css({opacity:1,marginBottom:10}).velocity({opacity:0,marginBottom:i?10:-t.$container.outerHeight()},"fast",(t=>l())):l(),t.destroy(),this.trigger("removeBlock",{block:t})},_setBlockEvents(t){t.on("removeBlock.input",(e=>{this.getSelectedBlocks().length>1?window.confirm(l().t("neo","Are you sure you want to delete the selected blocks?"))&&this._blockBatch(t,(t=>this.removeBlock(t))):this.removeBlock(t)})),t.on("toggleEnabled.input",(e=>this._blockBatch(t,(t=>t.toggleEnabled(e.enabled))))),t.on("toggleExpansion.input",(e=>this._blockBatch(t,(t=>t.toggleExpansion(e.expanded))))),t.on("moveUpBlock.input",(e=>this._moveBlock(t,"up"))),t.on("moveDownBlock.input",(e=>this._moveBlock(t,"down"))),t.on("newBlock.input",(e=>this["@newBlock"](Object.assign(e,{index:this._getNextBlockIndex(t)})))),t.on("addBlockAbove.input",(t=>this["@addBlockAbove"](t))),t.on("copyBlock.input",(t=>this["@copyBlock"](t))),t.on("pasteBlock.input",(t=>this["@pasteBlock"](t))),t.on("duplicateBlock.input",(t=>this["@duplicateBlock"](t))),t.on("change.input",(()=>this.trigger("change",{block:t})))},_moveBlock(t,e){var n;let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(!["up","down"].includes(e))return;null===(n=this.$form.data("elementEditor"))||void 0===n||n.pause();const o=t.getSiblings(this.getBlocks()),l=o.indexOf(t),a=l>0&&"up"===e,r=l<o.length-1&&"down"===e;if(-1===l||a===r)return;const c=!s().prefersReducedMotion()&&("boolean"!=typeof i||i),d=t.$container,h=()=>{d.detach(),a?o[l-1].$container.before(d):o[l+1].$container.after(d)},u=()=>{var t;this._updateBlockOrder(),this._updateButtons(),null===(t=this.$form.data("elementEditor"))||void 0===t||t.resume()};c?d.css({opacity:1,marginBottom:10}).velocity({opacity:0,marginBottom:-d.outerHeight()},"fast",(t=>{h(),d.css({opacity:0,marginBottom:-d.outerHeight()}).velocity({opacity:1,marginBottom:10},"fast",(t=>{u(),s().requestAnimationFrame((()=>s().scrollContainerToElement(d)))}))})):(h(),u())},getBlockByElement:t=>n()(t).data("block"),getBlocks(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return t>0?this._blocks.filter((e=>e.getLevel()===t)):Array.from(this._blocks)},getBlockTypeById(t){return this._blockTypes.find((e=>e.getId()===t))},getBlockTypeByHandle(t){return this._blockTypes.find((e=>e.getHandle()===t))},getBlockTypes(t){return(t="boolean"==typeof t&&t)?this._blockTypes.filter((t=>t.getTopLevel())):Array.from(this._blockTypes)},getGroups(){return Array.from(this._groups)},getItems(){return[...this.getBlockTypes(),...this.getGroups()].sort(((t,e)=>t.getSortOrder()-e.getSortOrder()))},getMaxBlocks(){return this._maxBlocks},getMaxTopBlocks(){return this._maxTopBlocks},getMinLevels(){return this._minLevels},getMaxLevels(){return this._maxLevels},atMaxLevels(t){return this._maxLevels>0&&t+1>this._maxLevels},getSelectedBlocks(){const t=this.blockSelect.getSelectedItems();return this._blocks.filter((e=>e.$container.closest(t).length>0))},getCopiedBlocks(){const t=window.localStorage.getItem("neo:copy:".concat(this._name));if(!t)return[];const{blocks:e}=JSON.parse(t);return e},setVisibleElements(t,e){"string"==typeof e&&(e=JSON.parse(e));null!==this._blocks.find((e=>e.getId()===t))&&(this._visibleLayoutElements[t]=e)},getNamespace(){return Array.from(this._templateNs)},getOwnerId(){return this._ownerId},getSiteId(){return this._siteId},getUnsavedIds(){return this.$blocksContainer.find('.ni_block[data-neo-b-id^="new"]').map(((t,e)=>e.getAttribute("data-neo-b-id").substring(3))).get()},_setMatrixClassErrors(){n()(".ni_block_body .matrix-field .input.errors").each((function(){const t=n()(this),e=t.closest(".ni_block_content_tab").data("neo-b-info"),i=t.closest(".ni_block").find('.tabs .tab[data-neo-b-info="'+e+'"]');i.length&&i.addClass("has-errors")}))},_setBlockTypeClassErrors(){const t=n()(".ni_block .tab.has-errors");t.each((function(){t.parents(".ni_block.is-collapsed").each((function(){n()(this).find("> .ni_block_topbar .title .blocktype").addClass("has-errors")}))}))},_updateBlockOrder(){const t=[];this.$blocksContainer.find(".ni_block").each(((e,n)=>{const i=this.getBlockByElement(n);t.push(i)})),this._blocks=t,this.trigger("updateBlockOrder"),this.trigger("change",{block:null})},_updateBlockChildren(){for(const t of this._blocks){const e=t.$blocksContainer.children(".ni_block"),n=Math.min(e.length,8),i=[];for(let t=0;t<n;t++)i.push('<div class="ni_block_collapsed-children_child"></div>');t.$collapsedChildrenContainer.html(i.join(""))}},_checkMaxChildren(t){if(!t)return!0;const e=t.getBlockType().getMaxChildBlocks();if(e>0){return this._findChildBlocks(t).length<e}return!0},_updateButtons(){var t;const e=this.getBlocks();this._buttons.updateButtonStates(e),null===(t=this._tempButtons)||void 0===t||t.updateButtonStates(e,this._checkMaxChildren(this._tempButtonsBlock));for(const t of e){var n;t.updateActionsMenu(),null===(n=t.getButtons())||void 0===n||n.updateButtonStates(e,this._checkMaxChildren(t),t),t.toggleShowButtons(!this.atMaxLevels(t.getLevel()))}},_blockBatch(t,e){const n=t.isSelected()?this.getSelectedBlocks():[t];for(const t of n)e(t)},_destroyTempButtons(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(t=!s().prefersReducedMotion()&&("boolean"!=typeof t||t),this._tempButtons){const e=this._tempButtons;e.off("newBlock"),t?e.$container.css({opacity:1,marginBottom:10}).velocity({opacity:0,marginBottom:-e.$container.outerHeight()},"fast",(t=>e.$container.remove())):e.$container.remove(),this._tempButtons=null,this._tempButtonsBlock=null}},_findPrevBlockOnLevel(t,e){t instanceof y&&(t=this._blocks.indexOf(t));let n=this._blocks[--t],i=Number.MAX_VALUE;for(;n;){const s=n.getLevel();if(s<i){if(s===e)return n;i=s}n=this._blocks[--t]}return!1},_findChildBlocks(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;t instanceof y&&(t=this._blocks.indexOf(t)),e="boolean"==typeof e&&e;const n=this._blocks[t];return n?n.getChildren(this._blocks,e):[]},_findParentBlock(t){t instanceof y&&(t=this._blocks.indexOf(t));const e=this._blocks,n=e[t];if(n){const i=n.getLevel();if(i>1){let s=t,o=n;for(;o&&o.getLevel()>=i;)o=e[--s];return o}}return null},_getNextBlockIndex(t){if(void 0===t)return 0;t instanceof y&&(t=this._blocks.indexOf(t));const e=this._findChildBlocks(t,!0),n=e[e.length-1];return(n?this._blocks.indexOf(n):t)+1},_registerDynamicBlockConditions(){setTimeout((()=>{var t;return null===(t=this.$form.data("elementEditor"))||void 0===t?void 0:t.on("update",(()=>this._updateAllVisibleElements()))}),200)},async _updateAllVisibleElements(){var t;const e=Math.floor(1e6*Math.random());this._lastFormCheck=e;const n=this.$form.data("elementEditor");if(null===(t=null==n?void 0:n.submittingForm)||void 0===t||t)return;if(this._newBlockCount>0)return void this._newBlockCount--;const i=n.settings.siteId;a.enter(this.getNamespace());const s={namespace:a.toFieldName(),blocks:{},sortOrder:[],fieldId:this._id,ownerCanonicalId:this._ownerId,ownerDraftId:n.settings.draftId,isProvisionalDraft:n.settings.isProvisionalDraft,siteId:i};a.leave();const o={};this._blocks.forEach((t=>{var e;const n=t.$contentContainer.children("[data-layout-tab]:not(.hidden)").data("layout-tab");s.blocks[t.getDuplicatedBlockId()]={selectedTab:null!=n?n:null,visibleLayoutElements:null!==(e=this._visibleLayoutElements[t.getId()])&&void 0!==e?e:{}},s.sortOrder.push(t.getDuplicatedBlockId()),o[t.getDuplicatedBlockId()]=t.getId()}));try{const t=await l().sendActionRequest("POST","neo/input/update-visible-elements",{data:s});if(this._lastFormCheck!==e)return;for(const e in t.data.blocks){const n=this._blocks.find((t=>t.getId()===o[e]));this._updateVisibleElements(n,t.data.blocks[e],s.blocks[n.getDuplicatedBlockId()].selectedTabId)}}catch(t){throw l().cp.displayError(t),t}},_updateVisibleElements(t,e,i){var o,a;let r=n()();const c={};let d=!1;for(let o=0;o<e.missingElements.length;o++){const a=e.missingElements[o];let h=t.$contentContainer.children('[data-layout-tab="'.concat(a.uid,'"]'));h.length||(h=n()("<div/>",{id:t.namespaceId(a.id),class:"flex-fields","data-id":a.id,"data-layout-tab":a.uid}),a.id!==i&&h.addClass("hidden"),h.appendTo(t.$contentContainer)),r=r.add(h);for(let e=0;e<a.elements.length;e++){const i=a.elements[e];if(!1!==i.html){if(c[a.uid]||(c[a.uid]=[]),c[a.uid].push(i.uid),"string"==typeof i.html){const e=i.html.replaceAll("__NEOBLOCK__",t.getId()),s=h.children('[data-layout-element="'.concat(i.uid,'"]')),o=n()(e);s.length?s.replaceWith(o):o.appendTo(h),l().initUiElements(o),o.hasClass("ni_child-blocks-ui-element")&&t.resetButtons(),d=!0}}else{const t=h.children('[data-layout-element="'.concat(i.uid,'"]'));if(!t.length||!s().hasAttr(t,"data-layout-element-placeholder")){const e=n()("<div/>",{class:"hidden","data-layout-element":i.uid,"data-layout-element-placeholder":""});t.length?t.replaceWith(e):e.appendTo(h),d=!0}}}d&&this._updateButtons()}const h=t.$contentContainer.children("[data-layout-tab]").not(r).not('[data-layout-tab=""]');h.length&&(h.remove(),d=!0),r.filter(":not(.hidden)").length||r.first().removeClass("hidden"),this._visibleLayoutElements[t.getId()]=c;const u=null!==(o=null===(a=e.tabs)||void 0===a||null===(a=a.match(/data-neo-b="([0-9]+).container.tabs"/))||void 0===a?void 0:a.pop())&&void 0!==o?o:null,p=u?e.tabs.replaceAll(u,t.getId()):e.tabs,g=n()(p);t.$topbarRightContainer.find(".tabs").empty().append(g),t.initTabs(),t.updateResponsiveness(),l().appendHeadHtml(e.headHtml.replaceAll("__NEOBLOCK__",t.getId())),l().appendBodyHtml(e.bodyHtml.replaceAll("__NEOBLOCK__",t.getId())),d&&e.initialDeltaValues&&Object.assign(this.$form.data("initial-delta-values"),e.initialDeltaValues)},_addSpinnerAfter(t){void 0!==t?t.$container.after(this._$spinner):this.$blocksContainer.prepend(this._$spinner),this._animateSpinner()},_addSpinnerBefore(t){void 0!==t?t.$container.before(this._$spinner):this.$blocksContainer.append(this._$spinner),this._animateSpinner()},_animateSpinner(){return s().prefersReducedMotion()?Promise.resolve():new Promise(((t,e)=>{try{this._$spinner.css({opacity:0,marginBottom:-this._$spinner.outerHeight()}).velocity({opacity:1,marginBottom:10},"fast",(()=>t()))}catch(t){e(t)}}))},_removeSpinner(){this._$spinner.remove()},async _duplicate(t,e){t.unsavedIds=this.getUnsavedIds();try{var n;null===(n=this.$form.data("elementEditor"))||void 0===n||n.pause(),await this._addSpinnerAfter(e);const i=await l().sendActionRequest("POST","neo/input/render-blocks",{data:t}),o=[];for(const t of i.data.blocks){const e=t.id,n=new y({namespace:[...this._templateNs,e],field:this,blockType:this.getBlockTypeById(t.type),blockHtml:t.blockHtml,bodyHtml:t.bodyHtml,headHtml:t.headHtml,id:e,uuid:t.uuid,level:0|t.level,enabled:!!t.enabled,collapsed:!!t.collapsed,showButtons:!this.atMaxLevels(0|t.level),showBlockTypeHandle:this._showBlockTypeHandles},!0);o.push(n)}let a=this._getNextBlockIndex(e);for(const t of o)this.addBlock(t,a++,t.getLevel(),!1);if(!s().prefersReducedMotion()&&o.length>0){const t=o[0];t.$container.css({opacity:0,marginBottom:this._$spinner.outerHeight()-t.$container.outerHeight()+10}).velocity({opacity:1,marginBottom:10},"fast",(e=>s().requestAnimationFrame((()=>s().scrollContainerToElement(t.$container)))))}}catch(t){l().cp.displayError(t.message)}finally{var i;this._removeSpinner(),null===(i=this.$form.data("elementEditor"))||void 0===i||i.resume()}},async"@newBlock"(t){const e=this.$form.data("elementEditor");try{var n,i,s,o,a;null==e||e.pause();const l=null!==(n=t.level)&&void 0!==n?n:1,r=void 0!==t.index?Math.min(t.index-1,this._blocks.length-1):this._blocks.length-1;let c,d=!0;for(let t=r;t>=0;t--){if(this._blocks[t].getLevel()===l){c=this._blocks[t];break}if(this._blocks[t].getLevel()<l){c=this._blocks[t+1],d=!1;break}}d?await this._addSpinnerAfter(c):await this._addSpinnerBefore(c);const h=d?null===(i=c)||void 0===i?void 0:i.getDuplicatedBlockId():null,u=null!==(s=null===(o=c)||void 0===o||null===(o=o.getParent())||void 0===o?void 0:o.getDuplicatedBlockId())&&void 0!==s?s:null,p=await t.blockType.newBlock({prevSiblingId:null!=h?h:null,parentId:u,level:l,ownerId:null!==(a=null==e?void 0:e.settings.elementId)&&void 0!==a?a:this._ownerId}),g=p.id,b=new y({namespace:[...this._templateNs,g],field:this,blockType:t.blockType,id:g,uuid:p.uuid,blockHtml:p.blockHtml,bodyHtml:p.bodyHtml,headHtml:p.headHtml,showButtons:!this.atMaxLevels(t.level),showBlockTypeHandle:this._showBlockTypeHandles},!0);this._removeSpinner(),this.addBlock(b,t.index,t.level,t.createChildBlocks,t.createChildBlocks)}catch(t){this._removeSpinner(),console.error(t),l().cp.displayError(t.message)}finally{null==e||e.resume()}},"@addBlockAbove"(t){this._destroyTempButtons();const e=!s().prefersReducedMotion()&&!1!==t.animate,n=t.block,i=this._blocks.indexOf(n),o=this._findParentBlock(i),l=this.getBlocks(),a=new this.ButtonClass({$ownerContainer:n.isTopLevel()?this.$container:n.getParent().$container,field:this,blockTypes:o?[]:this.getBlockTypes(!0),blocks:l,groups:o?[]:this.getGroups(),items:o?o.getBlockType().getChildBlockItems(this.getItems()):null,maxBlocks:this.getMaxBlocks()});n.$container.before(a.$container),a.on("newBlock",(t=>this["@newBlock"]({blockType:t.blockType,index:i,level:n.getLevel()}))),a.initUi(),e&&a.$container.css({opacity:0,marginBottom:-a.$container.outerHeight()}).velocity({opacity:1,marginBottom:10},"fast",(t=>s().requestAnimationFrame((()=>s().scrollContainerToElement(a.$container))))),this._tempButtons=a,this._tempButtonsBlock=this._findParentBlock(n),this._tempButtons.updateButtonStates(l,this._checkMaxChildren(this._tempButtonsBlock),this._tempButtonsBlock)},"@copyBlock"(t){const e=[];let n=0;const i=this._ownerId;this._blockBatch(t.block,(t=>{if(!(n>0&&-1!==e[e.length-1].indexOf(t))){const i=[];i.push(t,...this._findChildBlocks(t,!0)),e.push(i),n+=i.length}}));const s={field:this._name,blocks:[]};for(const t of e){const e=t[0].getLevel()-1;for(const n of t){const t={type:n.getBlockType().getId(),level:n.getLevel()-e,content:n.getContent(),ownerId:i};n.isEnabled()&&(t.enabled=1),n.isExpanded()||(t.collapsed=1),s.blocks.push(t)}}window.localStorage.setItem("neo:copy:".concat(this._name),JSON.stringify(s)),this._updateButtons();const o=1===n?"1 block copied":"{n} blocks copied";l().cp.displayNotice(l().t("neo",o,{n}))},"@pasteBlock"(t){var e;const n=t.block,i=(null!==(e=null==n?void 0:n.getLevel())&&void 0!==e?e:1)-1,s=this.getCopiedBlocks();if(s.length>0){for(const t of s)t.level+=i,t.ownerId=this._ownerId;a.enter(this._templateNs);const t={namespace:a.toFieldName(),fieldId:this._id,siteId:this._siteId,blocks:s};a.leave(),this._duplicate(t,n)}},"@duplicateBlock"(t){const e=t.block,n=this._blocks.indexOf(e),i=this._findChildBlocks(n,!0),s=this._ownerId,o=t=>({collapsed:0|!t.isExpanded(),content:t.getContent(),enabled:0|t.isEnabled(),level:t.getLevel(),ownerId:s,type:t.getBlockType().getId()});a.enter(this._templateNs);const l={namespace:a.toFieldName(),fieldId:this._id,siteId:this._siteId,blocks:[o(e),...i.map(o)]};a.leave(),this._duplicate(l,e)}});var H;const D=null!==(H=window)&&void 0!==H?H:void 0,P=[];D.Neo={Input:M,inputs:P,createInput(){const t=new M(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{});return P.push(t),t}}})();
//# sourceMappingURL=neo-main.js.map